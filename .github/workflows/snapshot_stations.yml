name: Snapshot Station Status

on:
  schedule:
    # Times in UTC (Boston is UTC-5 in winter, UTC-4 in summer/DST)
    # Midnight Boston = 5am UTC (winter)
    - cron: '0 5 * * *'    # 00:00 ET
    # 11:30pm Boston = 4:30am UTC (winter) 
    - cron: '30 4 * * *'   # 23:30 ET
    
    # Morning rush: every 30 minutes from 6am-9am
    # 6:00am Boston = 11:00am UTC (winter)
    - cron: '0 11 * * *'   # 06:00 ET
    - cron: '30 11 * * *'  # 06:30 ET
    # 7:00am-7:30am
    - cron: '0 12 * * *'   # 07:00 ET
    - cron: '30 12 * * *'  # 07:30 ET
    # 8:00am-8:30am
    - cron: '0 13 * * *'   # 08:00 ET
    - cron: '30 13 * * *'  # 08:30 ET
    # 9:00am
    - cron: '0 14 * * *'   # 09:00 ET
    
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  snapshot:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install requests python-dateutil pytz pyyaml python-dotenv
    
    - name: Run snapshot
      env:
        CI: true
      run: |
        python -m bluebikes_analysis.tasks.download_stations_data
    
    - name: Commit and push results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/raw/stations/station_status_*.csv
        git commit -m "Auto snapshot $(date -u +%Y-%m-%dT%H:%M:%SZ)" || echo "No changes"
        git push